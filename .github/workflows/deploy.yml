name: Deploy to Remote Server

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER_HOST }}
          username: ${{ secrets.DEPLOY_SERVER_USER }}
          key: ${{ secrets.DEPLOY_SERVER_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SERVER_PORT }}
          script: |
            echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞"
            cd /home/administrator/compose-root || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ compose-root"; exit 1; }

            echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è WB –Ω–∞ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            if [ -d WB ]; then
              cd WB
              if [[ -n $(git status --porcelain) ]]; then
                echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ WB –µ—Å—Ç—å –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
                git status
              else
                echo "‚úÖ WB —á–∏—Å—Ç"
              fi
              git pull || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å WB"
              cd ..
            else
              echo "‚ö†Ô∏è  –ü–∞–ø–∫–∞ WB –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            fi

            echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Philfana –Ω–∞ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            if [ -d Philfana ]; then
              cd Philfana
              if [[ -n $(git status --porcelain) ]]; then
                echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ Philfana –µ—Å—Ç—å –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
                git status
              else
                echo "‚úÖ Philfana —á–∏—Å—Ç"
              fi
              git pull || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å Philfana"
              cd ..
            else
              echo "‚ö†Ô∏è  –ü–∞–ø–∫–∞ Philfana –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            fi

            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
            docker-compose down || echo "‚ö†Ô∏è  docker-compose down –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"

            echo "‚öôÔ∏è –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤"
            docker-compose build || { echo "‚ùå –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å"; exit 1; }

            echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
            docker-compose up -d || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"; exit 1; }

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
